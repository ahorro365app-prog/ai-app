"use client";

import { useState, useEffect } from "react";
import { X, TrendingDown, TrendingUp, Wallet, CreditCard, Smartphone, Banknote, MoreHorizontal, Search, Calendar } from "lucide-react";
import { useCurrency } from "@/hooks/useCurrency";
import { useModal } from "@/contexts/ModalContext";

type TransactionType = 'expense' | 'income';
type PaymentMethod = 'cash' | 'card' | 'transfer' | 'qr' | 'other';

interface TransactionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (transaction: Transaction) => void;
}

interface Transaction {
  type: TransactionType;
  amount: number;
  category: string;
  paymentMethod: PaymentMethod;
  description: string;
  date: string;
}

const PAYMENT_METHODS = [
  { id: 'cash' as PaymentMethod, label: 'Efectivo', icon: Banknote, color: 'green' },
  { id: 'card' as PaymentMethod, label: 'Tarjeta', icon: CreditCard, color: 'blue' },
  { id: 'transfer' as PaymentMethod, label: 'Transferencia', icon: Smartphone, color: 'purple' },
  { id: 'qr' as PaymentMethod, label: 'QR', icon: Smartphone, color: 'indigo' },
  { id: 'other' as PaymentMethod, label: 'Otro', icon: MoreHorizontal, color: 'gray' },
];

const EXPENSE_CATEGORIES = [
  { id: 'comida', label: 'Comida', emoji: 'üçΩÔ∏è' },
  { id: 'transporte', label: 'Transporte', emoji: 'üöó' },
  { id: 'entretenimiento', label: 'Entretenimiento', emoji: 'üé¨' },
  { id: 'compras', label: 'Compras', emoji: 'üõçÔ∏è' },
  { id: 'salud', label: 'Salud', emoji: 'üíä' },
  { id: 'servicios', label: 'Servicios', emoji: 'üí°' },
  { id: 'otro', label: 'Otro', emoji: 'üì¶' },
];

const INCOME_CATEGORIES = [
  { id: 'salario', label: 'Salario', emoji: 'üí∞' },
  { id: 'freelance', label: 'Freelance', emoji: 'üíº' },
  { id: 'inversion', label: 'Inversi√≥n', emoji: 'üìà' },
  { id: 'regalo', label: 'Regalo', emoji: 'üéÅ' },
  { id: 'otro', label: 'Otro', emoji: 'üíµ' },
];

// Categor√≠as extendidas para gastos
const ALL_EXPENSE_CATEGORIES = [
  { id: 'restaurante', label: 'Restaurante', emoji: 'üç¥' },
  { id: 'supermercado', label: 'Supermercado', emoji: 'üõí' },
  { id: 'cafe', label: 'Caf√©', emoji: '‚òï' },
  { id: 'comida-rapida', label: 'Comida r√°pida', emoji: 'üçî' },
  { id: 'taxi', label: 'Taxi/Uber', emoji: 'üöï' },
  { id: 'autobus', label: 'Autob√∫s', emoji: 'üöå' },
  { id: 'gasolina', label: 'Gasolina', emoji: '‚õΩ' },
  { id: 'estacionamiento', label: 'Estacionamiento', emoji: 'üÖøÔ∏è' },
  { id: 'cine', label: 'Cine', emoji: 'üé•' },
  { id: 'concierto', label: 'Concierto', emoji: 'üéµ' },
  { id: 'deportes', label: 'Deportes', emoji: '‚öΩ' },
  { id: 'videojuegos', label: 'Videojuegos', emoji: 'üéÆ' },
  { id: 'ropa', label: 'Ropa', emoji: 'üëï' },
  { id: 'calzado', label: 'Calzado', emoji: 'üëü' },
  { id: 'electronica', label: 'Electr√≥nica', emoji: 'üíª' },
  { id: 'muebles', label: 'Muebles', emoji: 'üõãÔ∏è' },
  { id: 'medico', label: 'M√©dico', emoji: 'üë®‚Äç‚öïÔ∏è' },
  { id: 'farmacia', label: 'Farmacia', emoji: 'üíä' },
  { id: 'gimnasio', label: 'Gimnasio', emoji: 'üèãÔ∏è' },
  { id: 'belleza', label: 'Belleza', emoji: 'üíÑ' },
  { id: 'luz', label: 'Luz', emoji: 'üí°' },
  { id: 'agua', label: 'Agua', emoji: 'üíß' },
  { id: 'internet', label: 'Internet', emoji: 'üåê' },
  { id: 'telefono', label: 'Tel√©fono', emoji: 'üì±' },
  { id: 'alquiler', label: 'Alquiler', emoji: 'üè†' },
  { id: 'seguro', label: 'Seguro', emoji: 'üõ°Ô∏è' },
  { id: 'educacion', label: 'Educaci√≥n', emoji: 'üìö' },
  { id: 'libros', label: 'Libros', emoji: 'üìñ' },
  { id: 'regalos', label: 'Regalos', emoji: 'üéÅ' },
  { id: 'donaciones', label: 'Donaciones', emoji: '‚ù§Ô∏è' },
  { id: 'mascotas', label: 'Mascotas', emoji: 'üêæ' },
  { id: 'viajes', label: 'Viajes', emoji: '‚úàÔ∏è' },
  { id: 'hotel', label: 'Hotel', emoji: 'üè®' },
  { id: 'suscripciones', label: 'Suscripciones', emoji: 'üì∫' },
];

// Funci√≥n para migrar IDs de categor√≠as de ingl√©s a espa√±ol
const migrateOldCategories = () => {
  try {
    console.log('üîß Iniciando migraci√≥n de categor√≠as...');
    
    // Mapeo de IDs antiguos (ingl√©s) a nuevos (espa√±ol)
    const categoryIdMapping: Record<string, string> = {
      // Gastos b√°sicos
      'food': 'comida',
      'transport': 'transporte',
      'entertainment': 'entretenimiento',
      'shopping': 'compras',
      'health': 'salud',
      'bills': 'servicios',
      'other': 'otro',
      
      // Ingresos b√°sicos
      'salary': 'salario',
      'investment': 'inversion',
      'gift': 'regalo',
      
      // Ingresos extendidos
      'sale': 'venta',
      'bonus': 'bono',
      'freelance': 'freelance',
      'business': 'negocio',
      'dividend': 'dividendos',
      'rental': 'renta',
      'refund': 'reembolso',
      'gift-income': 'regalo',
      'prize': 'premio',
      'scholarship': 'beca',
      
      // Gastos extendidos
      'restaurant': 'restaurante',
      'groceries': 'supermercado',
      'coffee': 'cafe',
      'fast-food': 'comida-rapida',
      'bus': 'autobus',
      'gas': 'gasolina',
      'parking': 'estacionamiento',
      'cinema': 'cine',
      'concert': 'concierto',
      'sports': 'deportes',
      'games': 'videojuegos',
      'clothes': 'ropa',
      'shoes': 'calzado',
      'electronics': 'electronica',
      'furniture': 'muebles',
      'doctor': 'medico',
      'pharmacy': 'farmacia',
      'gym': 'gimnasio',
      'beauty': 'belleza',
      'electricity': 'luz',
      'water': 'agua',
      'phone': 'telefono',
      'rent': 'alquiler',
      'insurance': 'seguro',
      'education': 'educacion',
      'books': 'libros',
      'gifts': 'regalos',
      'donations': 'donaciones',
      'pets': 'mascotas',
      'travel': 'viajes',
      'subscriptions': 'suscripciones'
    };
    
    // 1. Migrar transacciones en localStorage
    const savedTransactions = localStorage.getItem('transactions');
    if (savedTransactions) {
      const transactions = JSON.parse(savedTransactions);
      let needsUpdate = false;
      
      const migratedTransactions = transactions.map((tx: any) => {
        if (categoryIdMapping[tx.category]) {
          needsUpdate = true;
          console.log(`üîÑ Migrando categor√≠a: ${tx.category} ‚Üí ${categoryIdMapping[tx.category]}`);
          return { ...tx, category: categoryIdMapping[tx.category] };
        }
        return tx;
      });
      
      if (needsUpdate) {
        localStorage.setItem('transactions', JSON.stringify(migratedTransactions));
        console.log('‚úÖ Transacciones migradas en localStorage');
      }
    }
    
    // 2. Migrar categor√≠as personalizadas
    const storedCategories = localStorage.getItem('customCategories');
    if (storedCategories) {
      const customCategories = JSON.parse(storedCategories);
      let needsUpdate = false;
      
      const migratedCategories = customCategories.map((cat: any) => {
        if (categoryIdMapping[cat.id]) {
          needsUpdate = true;
          console.log(`üîÑ Migrando categor√≠a personalizada: ${cat.id} ‚Üí ${categoryIdMapping[cat.id]}`);
          return { ...cat, id: categoryIdMapping[cat.id] };
        }
        return cat;
      });
      
      if (needsUpdate) {
        localStorage.setItem('customCategories', JSON.stringify(migratedCategories));
        console.log('‚úÖ Categor√≠as personalizadas migradas');
      }
    }
    
    console.log('‚úÖ Migraci√≥n de categor√≠as completada');
  } catch (error) {
    console.warn('Error al migrar categor√≠as:', error);
  }
};

// Funci√≥n para reconstruir categor√≠as personalizadas desde transacciones
const rebuildCustomCategories = (): void => {
  try {
    console.log('üîß Reconstruyendo categor√≠as personalizadas...');
    
    // Obtener todas las transacciones del localStorage
    const savedTransactions = localStorage.getItem('transactions');
    if (!savedTransactions) return;
    
    const transactions = JSON.parse(savedTransactions);
    const customCategories: any[] = [];
    
    // Buscar categor√≠as que empiecen con 'custom-'
    transactions.forEach((tx: any) => {
      if (tx.category && tx.category.startsWith('custom-')) {
        // Verificar si ya existe
        const exists = customCategories.some(cat => cat.id === tx.category);
        if (!exists) {
          // Extraer el nombre de la categor√≠a del ID (despu√©s de 'custom-')
          const categoryName = tx.category.replace('custom-', '').replace(/-/g, ' ');
          const label = categoryName
            .split(' ')
            .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
          
          customCategories.push({
            id: tx.category,
            label: label,
            emoji: 'üì¶' // Emoji por defecto
          });
        }
      }
    });
    
    if (customCategories.length > 0) {
      console.log('üìã Categor√≠as reconstruidas:', customCategories);
      localStorage.setItem('customCategories', JSON.stringify(customCategories));
      console.log('‚úÖ Categor√≠as personalizadas reconstruidas y guardadas');
    } else {
      console.log('‚ÑπÔ∏è No se encontraron categor√≠as personalizadas para reconstruir');
    }
  } catch (error) {
    console.warn('Error al reconstruir categor√≠as personalizadas:', error);
  }
};

// Funci√≥n para obtener el label de una categor√≠a por su ID
export const getCategoryLabel = (categoryId: string): string => {
  console.log('üîç Buscando categor√≠a para ID:', categoryId);
  
  // Si el categoryId no es un ID sino texto directo (como "Sale"), devolverlo tal como est√°
  if (!categoryId.startsWith('custom-') && !categoryId.includes('_') && !categoryId.includes('-')) {
    console.log('‚úÖ Categor√≠a como texto directo:', categoryId);
    return categoryId;
  }
  
  // Mapeo temporal para IDs antiguos (ingl√©s) a nuevos (espa√±ol)
  const categoryIdMapping: Record<string, string> = {
    // Gastos b√°sicos
    'food': 'comida',
    'transport': 'transporte',
    'entertainment': 'entretenimiento',
    'shopping': 'compras',
    'health': 'salud',
    'bills': 'servicios',
    'other': 'otro',
    
    // Ingresos b√°sicos
    'salary': 'salario',
    'investment': 'inversion',
    'gift': 'regalo',
    
    // Ingresos extendidos
    'sale': 'venta',
    'bonus': 'bono',
    'freelance': 'freelance',
    'business': 'negocio',
    'dividend': 'dividendos',
    'rental': 'renta',
    'refund': 'reembolso',
    'gift-income': 'regalo',
    'prize': 'premio',
    'scholarship': 'beca',
    
    // Gastos extendidos
    'restaurant': 'restaurante',
    'groceries': 'supermercado',
    'coffee': 'cafe',
    'fast-food': 'comida-rapida',
    'bus': 'autobus',
    'gas': 'gasolina',
    'parking': 'estacionamiento',
    'cinema': 'cine',
    'concert': 'concierto',
    'sports': 'deportes',
    'games': 'videojuegos',
    'clothes': 'ropa',
    'shoes': 'calzado',
    'electronics': 'electronica',
    'furniture': 'muebles',
    'doctor': 'medico',
    'pharmacy': 'farmacia',
    'gym': 'gimnasio',
    'beauty': 'belleza',
    'electricity': 'luz',
    'water': 'agua',
    'phone': 'telefono',
    'rent': 'alquiler',
    'insurance': 'seguro',
    'education': 'educacion',
    'books': 'libros',
    'gifts': 'regalos',
    'donations': 'donaciones',
    'pets': 'mascotas',
    'travel': 'viajes',
    'subscriptions': 'suscripciones'
  };
  
  // Si es un ID antiguo, convertirlo al nuevo
  const finalCategoryId = categoryIdMapping[categoryId] || categoryId;
  
  // Buscar en las categor√≠as predefinidas (ahora con IDs en espa√±ol)
  const allCategories = [...EXPENSE_CATEGORIES, ...INCOME_CATEGORIES, ...ALL_EXPENSE_CATEGORIES];
  const predefinedCategory = allCategories.find(cat => cat.id === finalCategoryId);
  if (predefinedCategory) {
    console.log('‚úÖ Encontrada en categor√≠as predefinidas:', predefinedCategory.label);
    return predefinedCategory.label;
  }
  
  // Si no se encuentra, buscar en las categor√≠as personalizadas almacenadas
  try {
    const storedCategories = localStorage.getItem('customCategories');
    if (storedCategories) {
      const customCategories = JSON.parse(storedCategories);
      const customCategory = customCategories.find((cat: any) => cat.id === finalCategoryId);
      
      if (customCategory) {
        console.log('‚úÖ Encontrada en categor√≠as personalizadas:', customCategory.label);
        return customCategory.label;
      }
    }
  } catch (error) {
    console.warn('Error al cargar categor√≠as personalizadas:', error);
  }
  
  // Si no se encuentra en ning√∫n lado, devolver el categoryId tal como est√°
  console.log('üîÑ Devolviendo categoryId tal como est√°:', categoryId);
  return categoryId;
};

// Mapeo de palabras clave a emojis sugeridos
const EMOJI_SUGGESTIONS: Record<string, string[]> = {
  // Comida
  'comida': ['üçΩÔ∏è', 'üç¥', 'üçï'],
  'restaurante': ['üçΩÔ∏è', 'üç¥', 'üè™'],
  'pizza': ['üçï', 'üç¥', 'üßÄ'],
  'hamburguesa': ['üçî', 'üçü', 'üå≠'],
  'cafe': ['‚òï', 'ü•§', 'üçµ'],
  'caf√©': ['‚òï', 'ü•§', 'üçµ'],
  'desayuno': ['ü•ê', 'üç≥', '‚òï'],
  'almuerzo': ['üçΩÔ∏è', 'üç¥', 'ü•ó'],
  'cena': ['üçΩÔ∏è', 'üåô', 'üç¥'],
  'postre': ['üç∞', 'üßÅ', 'üç©'],
  'dulce': ['üç≠', 'üç¨', 'üç´'],
  'bebida': ['ü•§', 'üç∫', 'üç∑'],
  'pan': ['ü•ê', 'üçû', 'ü•ñ'],
  
  // Transporte
  'transporte': ['üöó', 'üöå', 'üöï'],
  'taxi': ['üöï', 'üöó', 'üöñ'],
  'uber': ['üöï', 'üöó', 'üì±'],
  'bus': ['üöå', 'üöé', 'üöç'],
  'auto': ['üöó', 'üöô', 'üèéÔ∏è'],
  'carro': ['üöó', 'üöô', 'üèéÔ∏è'],
  'moto': ['üèçÔ∏è', 'üõµ', 'üèÅ'],
  'bici': ['üö¥', 'üö≤', 'üöµ'],
  'avion': ['‚úàÔ∏è', 'üõ´', 'üåç'],
  'avi√≥n': ['‚úàÔ∏è', 'üõ´', 'üåç'],
  'tren': ['üöÇ', 'üöÑ', 'üöá'],
  'metro': ['üöá', 'üöä', 'üöâ'],
  'gasolina': ['‚õΩ', 'üöó', 'üí®'],
  
  // Entretenimiento
  'cine': ['üé•', 'üçø', 'üé¨'],
  'pelicula': ['üé¨', 'üé•', 'üì∫'],
  'pel√≠cula': ['üé¨', 'üé•', 'üì∫'],
  'juego': ['üéÆ', 'üéØ', 'üé≤'],
  'deporte': ['‚öΩ', 'üèÄ', 'üéæ'],
  'gym': ['üèãÔ∏è', 'üí™', 'üèÉ'],
  'gimnasio': ['üèãÔ∏è', 'üí™', 'üèÉ'],
  'musica': ['üéµ', 'üé∂', 'üé∏'],
  'm√∫sica': ['üéµ', 'üé∂', 'üé∏'],
  'concierto': ['üé§', 'üé∏', 'üéµ'],
  'fiesta': ['üéâ', 'üéä', 'ü•≥'],
  'viaje': ['‚úàÔ∏è', 'üåç', 'üß≥'],
  'hotel': ['üè®', 'üõèÔ∏è', 'üè©'],
  
  // Salud
  'salud': ['üíä', 'üè•', '‚öïÔ∏è'],
  'doctor': ['üë®‚Äç‚öïÔ∏è', 'üè•', 'üíâ'],
  'medico': ['üë®‚Äç‚öïÔ∏è', 'üè•', 'üíä'],
  'm√©dico': ['üë®‚Äç‚öïÔ∏è', 'üè•', 'üíä'],
  'farmacia': ['üíä', 'üíâ', 'üè•'],
  'medicina': ['üíä', 'üíâ', 'ü©∫'],
  'dentista': ['ü¶∑', 'üë®‚Äç‚öïÔ∏è', 'üè•'],
  
  // Compras
  'compras': ['üõçÔ∏è', 'üõí', 'üí≥'],
  'ropa': ['üëï', 'üëî', 'üëó'],
  'zapatos': ['üëü', 'üë†', 'üëû'],
  'tecnologia': ['üíª', 'üì±', '‚å®Ô∏è'],
  'tecnolog√≠a': ['üíª', 'üì±', '‚å®Ô∏è'],
  'celular': ['üì±', 'üì≤', 'üí¨'],
  'computadora': ['üíª', 'üñ•Ô∏è', '‚å®Ô∏è'],
  'libro': ['üìö', 'üìñ', 'üìï'],
  'regalo': ['üéÅ', 'üéÄ', 'üéà'],
  
  // Casa y servicios
  'casa': ['üè†', 'üè°', 'üèòÔ∏è'],
  'alquiler': ['üè†', 'üîë', 'üèòÔ∏è'],
  'luz': ['üí°', '‚ö°', 'üîå'],
  'agua': ['üíß', 'üöø', 'üö∞'],
  'internet': ['üåê', 'üì∂', 'üíª'],
  'telefono': ['üì±', '‚òéÔ∏è', 'üìû'],
  'tel√©fono': ['üì±', '‚òéÔ∏è', 'üìû'],
  'limpieza': ['üßπ', 'üßΩ', 'üßº'],
  
  // Educaci√≥n
  'educacion': ['üìö', 'üéì', '‚úèÔ∏è'],
  'educaci√≥n': ['üìö', 'üéì', '‚úèÔ∏è'],
  'curso': ['üìö', 'üíª', 'üéì'],
  'escuela': ['üè´', 'üéí', 'üìö'],
  'universidad': ['üéì', 'üè´', 'üìö'],
  
  // Mascotas
  'mascota': ['üêæ', 'üêï', 'üêà'],
  'perro': ['üêï', 'üê∂', 'ü¶¥'],
  'gato': ['üêà', 'üê±', 'üêæ'],
  'veterinario': ['üêæ', 'üè•', 'üíâ'],
  
  // Trabajo
  'trabajo': ['üíº', 'üëî', 'üè¢'],
  'oficina': ['üè¢', 'üíº', 'üìä'],
  'negocio': ['üíº', 'üìà', 'üè™'],
  
  // Otros
  'seguro': ['üõ°Ô∏è', 'üìã', 'üîí'],
  'banco': ['üè¶', 'üí∞', 'üí≥'],
  'impuesto': ['üí∞', 'üìä', 'üèõÔ∏è'],
  'donacion': ['‚ù§Ô∏è', 'üéóÔ∏è', 'ü§ù'],
  'donaci√≥n': ['‚ù§Ô∏è', 'üéóÔ∏è', 'ü§ù'],
};

// Categor√≠as extendidas para ingresos
const ALL_INCOME_CATEGORIES = [
  { id: 'salary', label: 'Salario', emoji: 'üí∞' },
  { id: 'bonus', label: 'Bono', emoji: 'üéâ' },
  { id: 'freelance', label: 'Freelance', emoji: 'üíº' },
  { id: 'business', label: 'Negocio', emoji: 'üè™' },
  { id: 'investment', label: 'Inversiones', emoji: 'üìà' },
  { id: 'dividend', label: 'Dividendos', emoji: 'üíπ' },
  { id: 'rental', label: 'Renta', emoji: 'üèòÔ∏è' },
  { id: 'sale', label: 'Venta', emoji: 'ü§ù' },
  { id: 'refund', label: 'Reembolso', emoji: '‚Ü©Ô∏è' },
  { id: 'gift-income', label: 'Regalo', emoji: 'üéÅ' },
  { id: 'prize', label: 'Premio', emoji: 'üèÜ' },
  { id: 'scholarship', label: 'Beca', emoji: 'üéì' },
];

export default function TransactionModal({ isOpen, onClose, onSave }: TransactionModalProps) {
  const { currency, formatAmount } = useCurrency();
  const { setModalOpen } = useModal();
  
  const [type, setType] = useState<TransactionType>('expense');
  const [amount, setAmount] = useState('');
  const [category, setCategory] = useState('');
  const [paymentMethod, setPaymentMethod] = useState<PaymentMethod>('cash');
  const [description, setDescription] = useState('');
  const [showAllCategories, setShowAllCategories] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  // Funci√≥n para obtener la fecha de hoy en formato local YYYY-MM-DD
  const getTodayLocalDate = () => {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const result = `${year}-${month}-${day}`;
    console.log('üìÖ Fecha de hoy calculada:', result, '‚Üí', new Date(result + 'T00:00:00'));
    return result;
  };

  const [selectedDate, setSelectedDate] = useState(getTodayLocalDate());
  
  // Estados para drag & drop
  const [orderedCategories, setOrderedCategories] = useState<typeof ALL_EXPENSE_CATEGORIES>([]);
  const [draggedIndex, setDraggedIndex] = useState<number | null>(null);
  const [dragOverIndex, setDragOverIndex] = useState<number | null>(null);
  const [touchStartPos, setTouchStartPos] = useState<{ x: number; y: number } | null>(null);
  const [longPressTimer, setLongPressTimer] = useState<NodeJS.Timeout | null>(null);
  
  // Estados para agregar categor√≠a personalizada
  const [showAddCategory, setShowAddCategory] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [selectedEmoji, setSelectedEmoji] = useState('üìå');
  const [suggestedEmojis, setSuggestedEmojis] = useState<string[]>(['üìå', '‚≠ê', 'üí°']);
  
  // Manejar el estado del modal para ocultar el Navbar
  useEffect(() => {
    if (isOpen) {
      setModalOpen(true);
    } else {
      setModalOpen(false);
    }
    
    // Cleanup cuando el componente se desmonta
    return () => {
      setModalOpen(false);
    };
  }, [isOpen, setModalOpen]);

  // Cargar orden personalizado desde localStorage
  useEffect(() => {
    // Migrar categor√≠as antiguas primero
    migrateOldCategories();
    
    const savedOrder = localStorage.getItem('categoryOrder');
    if (savedOrder) {
      try {
        const parsedOrder = JSON.parse(savedOrder);
        setOrderedCategories(parsedOrder);
      } catch (e) {
        setOrderedCategories(ALL_EXPENSE_CATEGORIES);
      }
    } else {
      setOrderedCategories(ALL_EXPENSE_CATEGORIES);
    }
  }, []);
  
  // Guardar orden en localStorage cuando cambie
  useEffect(() => {
    if (orderedCategories.length > 0) {
      localStorage.setItem('categoryOrder', JSON.stringify(orderedCategories));
    }
  }, [orderedCategories]);
  
  // Limpiar temporizador al desmontar
  useEffect(() => {
    return () => {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
      }
    };
  }, [longPressTimer]);
  
  // Sugerir emojis bas√°ndose en el texto escrito
  useEffect(() => {
    if (!newCategoryName.trim()) {
      setSuggestedEmojis(['üìå', '‚≠ê', 'üí°']);
      setSelectedEmoji('üìå');
      return;
    }
    
    const searchText = newCategoryName.toLowerCase().trim();
    
    // Buscar coincidencias exactas o parciales en las palabras clave
    for (const [keyword, emojis] of Object.entries(EMOJI_SUGGESTIONS)) {
      if (searchText.includes(keyword) || keyword.includes(searchText)) {
        setSuggestedEmojis(emojis);
        setSelectedEmoji(emojis[0]); // Auto-seleccionar el primero
        return;
      }
    }
    
    // Si no hay coincidencias, usar emojis por defecto
    setSuggestedEmojis(['üìå', '‚≠ê', 'üí°']);
    setSelectedEmoji('üìå');
  }, [newCategoryName]);
  
  // Funci√≥n para guardar categor√≠a personalizada
  const handleSaveCustomCategory = () => {
    if (!newCategoryName.trim()) {
      alert('‚ö†Ô∏è Por favor ingresa un nombre para la categor√≠a');
      return;
    }
    
    const customId = `custom-${Date.now()}`;
    const newCategory = {
      id: customId,
      label: newCategoryName.trim(),
      emoji: selectedEmoji,
    };
    
    // Agregar al inicio de las categor√≠as ordenadas
    const updatedCategories = [newCategory, ...orderedCategories];
    setOrderedCategories(updatedCategories);
    
    // Guardar en localStorage para persistencia
    try {
      const existingCategories = JSON.parse(localStorage.getItem('customCategories') || '[]');
      
      // Eliminar duplicados bas√°ndose en el ID
      const uniqueCategories = existingCategories.filter((cat: any) => cat.id !== customId);
      
      // Agregar la nueva categor√≠a al inicio
      const updatedStoredCategories = [newCategory, ...uniqueCategories];
      
      localStorage.setItem('customCategories', JSON.stringify(updatedStoredCategories));
      console.log('üíæ Categor√≠a personalizada guardada:', newCategory);
      console.log('üì¶ Todas las categor√≠as personalizadas:', updatedStoredCategories);
    } catch (error) {
      console.warn('Error al guardar categor√≠a personalizada:', error);
    }
    
    // Seleccionar la nueva categor√≠a
    setCategory(customId);
    
    // Cerrar modales
    setShowAddCategory(false);
    setShowAllCategories(false);
    
    // Limpiar formulario
    setNewCategoryName('');
    setSelectedEmoji('üìå');
    
    // Mostrar confirmaci√≥n
    alert(`‚úÖ Categor√≠a "${newCategoryName.trim()}" creada exitosamente`);
  };
  
  // Funciones de drag & drop para desktop
  const handleDragStart = (e: React.DragEvent, index: number) => {
    setDraggedIndex(index);
    e.dataTransfer.effectAllowed = 'move';
    const target = e.currentTarget as HTMLElement;
    const rect = target.getBoundingClientRect();
    e.dataTransfer.setDragImage(target, rect.width / 2, rect.height / 2);
  };
  
  const handleDragEnd = (e: React.DragEvent) => {
    setDraggedIndex(null);
    setDragOverIndex(null);
  };
  
  const handleDragOver = (e: React.DragEvent, index: number) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    if (draggedIndex !== index) {
      setDragOverIndex(index);
    }
  };
  
  const handleDragLeave = () => {
    setDragOverIndex(null);
  };
  
  const handleDrop = (e: React.DragEvent, dropIndex: number) => {
    e.preventDefault();
    
    if (draggedIndex === null || draggedIndex === dropIndex) return;
    
    const newOrder = [...orderedCategories];
    const draggedItem = newOrder[draggedIndex];
    
    newOrder.splice(draggedIndex, 1);
    newOrder.splice(dropIndex, 0, draggedItem);
    
    setOrderedCategories(newOrder);
    setDraggedIndex(null);
    setDragOverIndex(null);
  };
  
  // Funciones de touch para m√≥viles
  const handleTouchStart = (e: React.TouchEvent, index: number) => {
    const touch = e.touches[0];
    setTouchStartPos({ x: touch.clientX, y: touch.clientY });
    
    // Iniciar temporizador para long press (500ms)
    const timer = setTimeout(() => {
      setDraggedIndex(index);
      // Vibrar si est√° disponible
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }, 500);
    
    setLongPressTimer(timer);
  };
  
  const handleTouchMove = (e: React.TouchEvent) => {
    if (draggedIndex === null) {
      // Si nos movemos antes del long press, cancelarlo
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        setLongPressTimer(null);
      }
      return;
    }
    
    // Prevenir scroll mientras arrastramos
    e.preventDefault();
    
    const touch = e.touches[0];
    const element = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (element) {
      const button = element.closest('button[data-category-index]');
      if (button) {
        const index = parseInt(button.getAttribute('data-category-index') || '-1');
        if (index !== -1 && index !== draggedIndex) {
          setDragOverIndex(index);
        }
      }
    }
  };
  
  const handleTouchEnd = (e: React.TouchEvent) => {
    if (longPressTimer) {
      clearTimeout(longPressTimer);
      setLongPressTimer(null);
    }
    
    if (draggedIndex !== null && dragOverIndex !== null && draggedIndex !== dragOverIndex) {
      const newOrder = [...orderedCategories];
      const draggedItem = newOrder[draggedIndex];
      
      newOrder.splice(draggedIndex, 1);
      newOrder.splice(dragOverIndex, 0, draggedItem);
      
      setOrderedCategories(newOrder);
      
      // Vibrar para confirmar
      if (navigator.vibrate) {
        navigator.vibrate([30, 50, 30]);
      }
    }
    
    setDraggedIndex(null);
    setDragOverIndex(null);
    setTouchStartPos(null);
  };

  if (!isOpen) return null;

  const categories = type === 'expense' ? EXPENSE_CATEGORIES : INCOME_CATEGORIES;
  const allCategories = type === 'expense' ? orderedCategories : ALL_INCOME_CATEGORIES;
  
  // Filtrar categor√≠as seg√∫n b√∫squeda
  const filteredCategories = searchTerm 
    ? allCategories.filter(cat => cat.label.toLowerCase().includes(searchTerm.toLowerCase()))
    : allCategories;
  
  const selectedCategory = categories.find(c => c.id === category) || 
                          allCategories.find(c => c.id === category);
                          
  const handleCategoryClick = (catId: string) => {
    console.log('üîç Categor√≠a clickeada:', catId);
    if (catId === 'otro') {
      console.log('üìÇ Abriendo men√∫ de categor√≠as personalizadas');
      setShowAllCategories(true);
    } else {
      console.log('‚úÖ Seleccionando categor√≠a:', catId);
      setCategory(catId);
      setShowAllCategories(false);
    }
  };

  // Calcular fecha m√≠nima (6 d√≠as atr√°s)
  const getMinDate = () => {
    const date = new Date();
    date.setDate(date.getDate() - 6);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const result = `${year}-${month}-${day}`;
    console.log('üìÖ Fecha m√≠nima calculada:', result, '‚Üí', new Date(result + 'T00:00:00'));
    return result;
  };

  // Calcular fecha m√°xima (hoy)
  const getMaxDate = () => {
    const result = getTodayLocalDate();
    console.log('üìÖ Fecha m√°xima calculada:', result, '‚Üí', new Date(result + 'T23:59:59'));
    return result;
  };

  const handleSave = () => {
    if (!amount || !category) {
      alert('Por favor completa todos los campos obligatorios');
      return;
    }

    // Validar que la fecha est√© dentro del rango permitido
    const minDate = getMinDate();
    const maxDate = getMaxDate();
    
    // Convertir fechas a objetos Date para comparaci√≥n correcta (usando hora local)
    const selectedDateObj = new Date(selectedDate + 'T00:00:00');
    const minDateObj = new Date(minDate + 'T00:00:00');
    const maxDateObj = new Date(maxDate + 'T23:59:59');
    
    console.log('üîç Validaci√≥n de fechas:');
    console.log('Fecha seleccionada:', selectedDate, '‚Üí', selectedDateObj);
    console.log('Fecha m√≠nima:', minDate, '‚Üí', minDateObj);
    console.log('Fecha m√°xima:', maxDate, '‚Üí', maxDateObj);
    console.log('Es menor que m√≠nima:', selectedDateObj < minDateObj);
    console.log('Es mayor que m√°xima:', selectedDateObj > maxDateObj);
    
    if (selectedDateObj < minDateObj || selectedDateObj > maxDateObj) {
      alert('La fecha debe estar dentro de los √∫ltimos 6 d√≠as');
      return;
    }

    // Usar la fecha seleccionada con la hora actual (en hora local, no UTC)
    const now = new Date();
    const [year, month, day] = selectedDate.split('-').map(Number);
    const transactionDate = new Date(year, month - 1, day, now.getHours(), now.getMinutes(), now.getSeconds());

    const transaction: Transaction = {
      type,
      amount: parseFloat(amount),
      category,
      paymentMethod,
      description,
      date: transactionDate.toISOString(),
    };

    onSave(transaction);
    
    // Resetear formulario
    setAmount('');
    setCategory('');
    setPaymentMethod('cash');
    setDescription('');
    setSelectedDate(getTodayLocalDate());
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
      <div className="bg-white rounded-3xl p-6 max-w-md w-full shadow-2xl animate-scale-in max-h-[90vh] flex flex-col">
        {/* Header fijo */}
        <div className="flex-shrink-0">
          <div className="w-16 h-16 rounded-full bg-gradient-to-r from-blue-100 to-purple-100 mx-auto mb-4 flex items-center justify-center">
            {type === 'expense' ? (
              <TrendingDown size={32} className="text-blue-600" />
            ) : (
              <TrendingUp size={32} className="text-green-600" />
            )}
          </div>

          <h3 className="text-2xl font-bold text-gray-900 text-center mb-2">
            {type === 'expense' ? 'Registrar Gasto' : 'Registrar Ingreso'}
          </h3>
        </div>

        {/* Contenido scrolleable */}
        <div className="flex-1 overflow-y-auto scrollbar-hide">
          <div className="space-y-4 mb-6">
            {/* Tipo de transacci√≥n */}
            <div>
              <label className="block text-xs font-semibold text-gray-700 mb-2">
                Tipo de transacci√≥n *
              </label>
              <div className="flex bg-gray-100 rounded-xl p-1">
                <button
                  onClick={() => setType('expense')}
                  className={`
                    flex-1 py-3 px-4 rounded-lg font-semibold text-sm transition-all flex items-center justify-center gap-2
                    ${type === 'expense' 
                      ? 'bg-gradient-to-r from-red-500 to-red-600 text-white shadow-md' 
                      : 'text-gray-600 hover:text-gray-900'
                    }
                  `}
                >
                  <TrendingDown size={16} />
                  Gasto
                </button>
                <button
                  onClick={() => setType('income')}
                  className={`
                    flex-1 py-3 px-4 rounded-lg font-semibold text-sm transition-all flex items-center justify-center gap-2
                    ${type === 'income' 
                      ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-md' 
                      : 'text-gray-600 hover:text-gray-900'
                    }
                  `}
                >
                  <TrendingUp size={16} />
                  Ingreso
                </button>
              </div>
            </div>

            {/* Monto */}
            <div>
              <label className="block text-xs font-semibold text-gray-700 mb-2">
                Monto *
              </label>
              <input
                type="number"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                placeholder="0.00"
                min="0"
                step="0.01"
                className="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-gray-200 focus:border-blue-500 focus:outline-none modal-input"
                autoFocus
              />
            </div>

            {/* Fecha - Carrusel de botones */}
            <div>
              <label className="block text-xs font-semibold text-gray-700 mb-2">
                Fecha *
              </label>
              <div className="relative">
                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory px-1">
                {Array.from({ length: 7 }, (_, i) => {
                  const date = new Date();
                  date.setDate(date.getDate() - i);
                  // Usar fecha local en lugar de UTC para evitar problemas de zona horaria
                  const year = date.getFullYear();
                  const month = String(date.getMonth() + 1).padStart(2, '0');
                  const day = String(date.getDate()).padStart(2, '0');
                  const dateString = `${year}-${month}-${day}`;
                  const dayName = date.toLocaleDateString('es-ES', { weekday: 'short' });
                  const dayNumber = date.getDate();
                  const monthName = date.toLocaleDateString('es-ES', { month: 'short' });
                  const isToday = i === 0;
                  const isSelected = selectedDate === dateString;
                  
                  console.log(`üìÖ Bot√≥n fecha ${i}: ${dateString} (${dayName} ${dayNumber} ${monthName}) - Seleccionado: ${isSelected}`);
                  
                  return (
                    <button
                      key={dateString}
                      type="button"
                      onClick={() => setSelectedDate(dateString)}
                      className={`
                        flex-shrink-0 flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all min-w-[60px] snap-center
                        ${isSelected 
                          ? 'bg-gradient-to-r from-blue-500 to-purple-600 border-blue-500 text-white shadow-lg' 
                          : 'bg-white border-gray-200 text-gray-700 hover:border-blue-300 hover:bg-blue-50'
                        }
                        ${isToday ? 'ring-2 ring-blue-200' : ''}
                      `}
                    >
                      <span className={`text-xs font-semibold ${isSelected ? 'text-white' : 'text-gray-500'}`}>
                        {dayName}
                      </span>
                      <span className={`text-lg font-bold ${isSelected ? 'text-white' : 'text-gray-900'}`}>
                        {dayNumber}
                      </span>
                      <span className={`text-[10px] ${isSelected ? 'text-blue-100' : 'text-gray-500'}`}>
                        {monthName}
                      </span>
                      {isToday && (
                        <span className="text-[8px] bg-blue-600 text-white px-1 rounded-full mt-1">
                          HOY
                        </span>
                      )}
                    </button>
                  );
                })}
                </div>
              </div>
              <p className="text-xs text-gray-500 mt-2">
                Solo puedes registrar gastos de los √∫ltimos 6 d√≠as
              </p>
            </div>

            {/* Categor√≠a - Carrusel */}
            <div>
              <label className="block text-xs font-semibold text-gray-700 mb-2">
                Categor√≠a *
              </label>
              <div className="relative">
                <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory px-1">
                  {categories.map((cat) => (
                    <button
                      key={cat.id}
                      onClick={() => handleCategoryClick(cat.id)}
                      className={`
                        flex-shrink-0 flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all min-w-[80px] snap-center
                        ${category === cat.id 
                          ? 'border-blue-500 bg-gradient-to-r from-blue-500 to-purple-600 shadow-lg text-white' 
                          : 'border-gray-200 bg-white hover:border-blue-300 hover:bg-blue-50 text-gray-700'
                        }
                      `}
                    >
                      <span className="text-lg mb-1">{cat.emoji}</span>
                      <span className={`text-xs font-bold text-center ${category === cat.id ? 'text-white' : 'text-gray-700'}`}>
                        {cat.label}
                      </span>
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* M√©todo de pago (solo para gastos) - Carrusel */}
            {type === 'expense' && (
              <div>
                <label className="block text-xs font-semibold text-gray-700 mb-2">
                  M√©todo de pago
                </label>
                <div className="relative">
                  <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory px-1">
                    {PAYMENT_METHODS.map((method) => {
                      const Icon = method.icon;
                      return (
                        <button
                          key={method.id}
                          onClick={() => setPaymentMethod(method.id)}
                          className={`
                            flex-shrink-0 flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all min-w-[80px] snap-center
                            ${paymentMethod === method.id 
                              ? 'border-blue-500 bg-gradient-to-r from-blue-500 to-purple-600 shadow-lg text-white' 
                              : 'border-gray-200 bg-white hover:border-blue-300 hover:bg-blue-50 text-gray-700'
                            }
                          `}
                        >
                          <Icon 
                            size={20} 
                            className={`${paymentMethod === method.id ? 'text-white' : 'text-gray-400'}`} 
                          />
                          <p className={`text-xs font-bold text-center mt-1 ${paymentMethod === method.id ? 'text-white' : 'text-gray-700'}`}>
                            {method.label}
                          </p>
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}

            {/* Descripci√≥n */}
            <div>
              <label className="block text-xs font-semibold text-gray-700 mb-2">
                Descripci√≥n (opcional)
              </label>
              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                className="w-full px-4 py-3 rounded-xl bg-gray-50 border-2 border-gray-200 focus:border-blue-500 focus:outline-none modal-input"
                placeholder="Ej: Almuerzo en restaurante italiano..."
                rows={3}
              />
            </div>
          </div>
        </div>

        {/* Footer fijo */}
        <div className="flex-shrink-0 pt-4 border-t border-gray-100">
          <div className="flex gap-3">
            <button
              onClick={onClose}
              className="flex-1 py-3.5 px-4 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-all"
            >
              Cancelar
            </button>
            <button
              onClick={handleSave}
              className={`
                flex-1 py-3.5 px-4 rounded-xl font-semibold text-white transition-all shadow-lg
                ${type === 'expense' 
                  ? 'bg-gradient-to-r from-red-500 to-orange-500 hover:opacity-90' 
                  : 'bg-gradient-to-r from-green-500 to-green-600 hover:opacity-90'
                }
              `}
            >
              {type === 'expense' ? 'Registrar Gasto' : 'Registrar Ingreso'}
            </button>
          </div>
        </div>
      </div>
      
      {/* Modal de categor√≠as extendidas - Pantalla completa independiente */}
      {showAllCategories && (
        <div className="fixed inset-0 bg-white z-[60] flex flex-col animate-fade-in">
          {/* Header */}
          <div className="flex-shrink-0 bg-white border-b border-gray-200 p-4 space-y-3">
            <div className="flex items-center justify-between">
              <h3 className="text-sm font-bold text-gray-900">Seleccionar categor√≠a</h3>
              <button
                onClick={() => {
                  setShowAllCategories(false);
                  setSearchTerm('');
                }}
                className="p-2 rounded-lg hover:bg-gray-100 transition-colors"
              >
                <X size={20} className="text-gray-600" />
              </button>
            </div>
            
            {/* Buscador */}
            <div className="flex items-center gap-2 px-3 py-2.5 rounded-xl bg-gray-50 border-2 border-gray-200 focus-within:border-blue-500 transition-colors">
              <Search size={18} className="text-gray-400" />
              <input
                type="text"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                placeholder="Buscar categor√≠a..."
                className="flex-1 bg-transparent text-sm text-gray-900 focus:outline-none placeholder-gray-400"
                autoFocus
              />
            </div>
            
            {/* Categor√≠a seleccionada */}
            {category && selectedCategory && (
              <div className="flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-50 border border-blue-200">
                <span className="text-xl">{selectedCategory.emoji}</span>
                <span className="text-xl font-semibold text-blue-900">{selectedCategory.label}</span>
                <span className="text-xl text-blue-600 ml-auto">Seleccionada ‚úì</span>
              </div>
            )}
          </div>
          
          {/* Lista de categor√≠as - Con scroll y drag & drop */}
          <div className="flex-1 overflow-y-auto scrollbar-hide p-4 pb-2">
            {!searchTerm && (
              <div className="mb-3 px-1">
                <p className="text-xl text-gray-500 flex items-center gap-1.5">
                  <span className="text-xl">‚úã</span>
                  <span>Mant√©n presionado para reordenar</span>
                </p>
              </div>
            )}
            <div className="grid grid-cols-3 gap-2 relative">
              {filteredCategories.map((cat, index) => (
                <button
                  key={cat.id}
                  data-category-index={index}
                  draggable={!searchTerm}
                  onDragStart={(e) => handleDragStart(e, index)}
                  onDragEnd={handleDragEnd}
                  onDragOver={(e) => handleDragOver(e, index)}
                  onDragLeave={handleDragLeave}
                  onDrop={(e) => handleDrop(e, index)}
                  onTouchStart={(e) => !searchTerm && handleTouchStart(e, index)}
                  onTouchMove={(e) => !searchTerm && handleTouchMove(e)}
                  onTouchEnd={(e) => !searchTerm && handleTouchEnd(e)}
                  onClick={() => {
                    if (draggedIndex === null) {
                      setCategory(cat.id);
                    }
                  }}
                  className={`
                    p-3 rounded-2xl border-2 transition-all duration-150 flex flex-col items-center gap-1 select-none relative
                    ${!searchTerm ? 'cursor-grab active:cursor-grabbing' : 'cursor-pointer'}
                    ${category === cat.id
                      ? 'border-blue-500 bg-blue-50'
                      : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                    }
                    ${draggedIndex === index ? 'opacity-60 scale-105 z-50' : ''}
                    ${dragOverIndex === index && draggedIndex !== index ? 'bg-gray-100 scale-95' : ''}
                  `}
                  style={{
                    transition: 'all 0.15s cubic-bezier(0.4, 0, 0.2, 1)',
                  }}
                >
                  <span className={`text-xl pointer-events-none transition-transform duration-150 ${draggedIndex === index ? 'scale-110' : ''}`}>
                    {cat.emoji}
                  </span>
                  <span className={`text-[10px] font-medium text-center pointer-events-none ${category === cat.id ? 'text-blue-600' : 'text-gray-700'}`}>
                    {cat.label}
                  </span>
                </button>
              ))}
              
              {/* Bot√≥n para a√±adir categor√≠a personalizada */}
              {!searchTerm && (
                <button
                  onClick={() => setShowAddCategory(true)}
                  className="p-3 rounded-2xl border-2 border-dashed border-gray-300 bg-gray-50 hover:border-blue-400 hover:bg-blue-50 transition-all duration-150 flex flex-col items-center gap-1 cursor-pointer"
                >
                  <span className="text-xl">‚ûï</span>
                  <span className="text-[10px] font-medium text-center text-gray-600">
                    A√±adir
                  </span>
                </button>
              )}
            </div>
            
            {filteredCategories.length === 0 && (
              <div className="text-center py-12">
                <p className="text-gray-500 text-xl">No se encontraron categor√≠as</p>
                <p className="text-gray-400 text-xl mt-1">Intenta con otro t√©rmino de b√∫squeda</p>
              </div>
            )}
          </div>
          
          {/* Botones de acci√≥n - SIEMPRE FIJO EN BOTTOM */}
          <div className="flex-shrink-0 p-4 pb-6 bg-white border-t border-gray-200 shadow-lg">
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setShowAllCategories(false);
                  setSearchTerm('');
                }}
                className="flex-1 py-3.5 px-4 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 hover:scale-[1.02] active:scale-[0.98] transition-all"
              >
                Cancelar
              </button>
              <button
                onClick={() => {
                  setShowAllCategories(false);
                  setSearchTerm('');
                }}
                disabled={!category}
                className={`
                  flex-1 py-3.5 px-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2
                  ${category
                    ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:opacity-90 hover:scale-[1.02] active:scale-[0.98]'
                    : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  }
                `}
              >
                {category && <span className="text-xl">{selectedCategory?.emoji}</span>}
                {category ? `Confirmar: ${selectedCategory?.label}` : 'Selecciona una categor√≠a'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Modal para a√±adir categor√≠a personalizada */}
      {showAddCategory && (
        <div className="fixed inset-0 bg-white z-[70] flex flex-col animate-fade-in">
          {/* Header */}
          <div className="flex-shrink-0 bg-gradient-to-r from-blue-500 to-purple-600 p-4">
            <div className="flex items-center justify-between">
              <h3 className="text-xl font-bold text-white">Crear Categor√≠a</h3>
              <button
                onClick={() => {
                  setShowAddCategory(false);
                  setNewCategoryName('');
                  setSelectedEmoji('üìå');
                }}
                className="p-2 rounded-lg hover:bg-white/20 transition-colors"
              >
                <X size={20} className="text-white" />
              </button>
            </div>
          </div>
          
          {/* Content */}
          <div className="flex-1 overflow-y-auto p-4 space-y-6">
            {/* Nombre de la categor√≠a */}
            <div>
              <label className="block text-xl font-semibold text-gray-700 mb-2">
                Nombre de la categor√≠a *
              </label>
              <input
                type="text"
                value={newCategoryName}
                onChange={(e) => setNewCategoryName(e.target.value)}
                placeholder="Ej: Mi categor√≠a"
                className="w-full px-4 py-3 rounded-xl bg-white border-2 border-gray-200 focus:border-blue-500 focus:outline-none text-gray-900 transition-all"
                autoFocus
                maxLength={20}
              />
              <p className="text-xl text-gray-500 mt-1 pl-1">
                {newCategoryName.length}/20 caracteres
              </p>
            </div>
            
            {/* Selector de emoji - Sugerencias autom√°ticas */}
            <div>
              <label className="block text-xl font-semibold text-gray-700 mb-2">
                Emoji sugerido
              </label>
              <p className="text-xl text-gray-500 mb-3">
                Se selecciona autom√°ticamente seg√∫n el nombre
              </p>
              <div className="flex gap-3 justify-center">
                {suggestedEmojis.map((emoji) => (
                  <button
                    key={emoji}
                    onClick={() => setSelectedEmoji(emoji)}
                    className={`
                      p-4 rounded-2xl border-2 transition-all duration-200 flex items-center justify-center
                      ${selectedEmoji === emoji
                        ? 'border-blue-500 bg-gradient-to-br from-blue-50 to-purple-50 scale-110 shadow-lg'
                        : 'border-gray-200 hover:border-blue-300 hover:bg-blue-50 hover:scale-105'
                      }
                    `}
                  >
                    <span className="text-xl">{emoji}</span>
                  </button>
                ))}
              </div>
            </div>
            
            {/* Preview */}
            <div className="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 border-2 border-blue-200">
              <p className="text-xl font-semibold text-gray-600 mb-3 text-center">Vista previa</p>
              <div className="flex items-center justify-center gap-3">
                <span className="text-xl">{selectedEmoji}</span>
                <span className="text-xl font-bold text-gray-900">
                  {newCategoryName || 'Nombre de categor√≠a'}
                </span>
              </div>
            </div>
          </div>
          
          {/* Footer con botones */}
          <div className="flex-shrink-0 p-4 pb-6 bg-white border-t border-gray-200 shadow-lg">
            <div className="flex gap-3">
              <button
                onClick={() => {
                  setShowAddCategory(false);
                  setNewCategoryName('');
                  setSelectedEmoji('üìå');
                }}
                className="flex-1 py-3.5 px-4 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-all"
              >
                Cancelar
              </button>
              <button
                onClick={handleSaveCustomCategory}
                disabled={!newCategoryName.trim()}
                className={`
                  flex-1 py-3.5 px-4 rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2
                  ${newCategoryName.trim()
                    ? 'bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:opacity-90 hover:scale-[1.02] active:scale-[0.98]'
                    : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  }
                `}
              >
                ‚úÖ Crear Categor√≠a
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}



